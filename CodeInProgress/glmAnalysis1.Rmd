---
title: "Fire_WPBR_InteractionAnalysis_glmm"
author: "Jenny Cribbs"
date: "2024-01-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

An interaction analysis investigates whether the relationship between two variables varies across different levels of another variable. In this case, we are interested in multiple variables that may affect the incidence of white pine blister rust (WPBR). Fire severity and density of sugar pine (PILA) are the primary explanatory variables of interest in this analysis. Tree size (height or DBH--probably not both since they are tightly correlated), and bark beetle activity may be other variables of interest. 

We would expect that higher density of the host species (PILA) would be associated with increased incidence of WPBR. 

Fire effects are less predictable. Fire could have a sanitizing effect by killing the fungal pathogen Cronartium ribicola directly or by reducing the density of host tree species to the point of limiting new infections and the spread of existing infections. Furthermore, fire could induce tree defense mechanisms, making surviving trees more likely to defend against new infections. However, it is also possible that fire injury can weaken trees, depleting their defense mechanisms and leaving them more susceptible to new WPBR infections. 

## Defining Variables

Our response variable is WPBR, but we need to decide how to operationalize the variable. Field crews counted branch cankers, bole cankers, dead tops, and flags. They also assessed percent live, a global health score based on the percent of live green vegetation relative to recent dead red needles. The WPBR summary statistics calculated for the December 2023 NPS report are reported as the percentage of infected trees relative to uninfected trees. As such, incidence is a continuous variable (in that it is a percentage derived from count data), percent live is a continuous percentage (derived from a subjective estimate that realistically only included whole numbers), and all other variables are count data. This initial model will consider the count data, leaving the derived incidence and subjective percent live for a future analysis. 

Although dead tops, flags, and percent live may be important in refining our response variable WPBR in the future, at present we will focus on cankers since they represent the most definitive signs of WPBR. We will lump active and inactive cankers and branch and bole cankers together, though it may be useful to consider these counts separately in follow up analysis. 

canker_count = active branch canker count + active bole canker count + inactive branch canker count + inactive bole canker count 

This new variable represents a count of all cankers on a given tree regardless of their location (branch versus bole) or status (active versus inactive). A canker count of zero implies an true uninfected tree (or a false negative). A canker count greater than zero implies an true infected tree (or a false positive).

Fixed effects should include the predictors that we expect to influence WPBR incidence based on theory. PILA density should affect canker counts simply because increasing PILA density increases the number of host trees for the fungus to infect. Fire severity may affect canker counts in complex was as discussed above. Tree size may affect canker counts because larger trees may have some degree of resistance due to their larger size and greater defense reserves. 

The following simple models would consider to what extent these three fixed effects (fire severity, host tree density, and tree size) independently influence canker count. 

Because plots were selected according to a stratified random sampling design within known sugar pine distribution in Yosemite, plotID is a random effect in the model. [Should there be other random effects? Crew maybe?]

Reduced models:
canker_count ~ fire severity + 1|plotID
canker_count ~ PILA density + 1|plotID
canker_count ~ tree size + 1|plotID

Full model (but no beetles)
canker_count ~ PILA density + fire severity + tree size + 1|plotID

Full interaction model (but no beetles)
canker_count ~ PILA density + fire severity + tree size + PILA density * fire severity + PILA density * tree size + fire severity * tree size + 1|plotID

Model evaluation using AIC and BIC can help evaluate which model best predicts canker count based on the given predictor valuables. 

## Set Up

```{r, echo=FALSE}
# install if necessary
# install.packages("lme4")  # For fitting mixed-effects models
# install.packages("glmmTMB")  # For fitting GLMMs with negative binomial # distribution
# install.packages("lmerTest")  # For obtaining p-values for mixed-effects models

# load packages
library(tidyverse)
library(lme4)
library(glmmTMB)
library(lmerTest)

# more set up
if (!require("librarian")) install.packages("librarian")
librarian::shelf(tidyverse, readxl, viridis, patchwork)

theme_set(
  theme_bw(base_size = 17)+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
)

files <- list.files()
outdir <- "/Users/jennifercribbs/Documents/YOSE/Analysis/YPE_Data"

## unzipping files on your computer
setwd("/Users/jennifercribbs/Documents/YOSE/Analysis/YPE_Data")
files <- list.files()
outdir <- "/Users/jennifercribbs/Documents/YOSE/Analysis/YPE_Data"

## for loop to unzip files on your computer
# for (file in files) {
#   unzip(paste0(outdir,"/", file))
# }


## reading in all data
folders <- list.dirs(outdir)[-c(1,4)]

tree_list <- data.frame()

for (folder in folders) {
  newfiles = list.files(folder, pattern = "PILAdata")
  for(file in newfiles) {
    xlsfile <- read_excel(paste0(folder,"/",file)) %>% 
      dplyr::select(plotID, plot_type, DBH_cm, height_m, pitchTubes, exitHoles, activeBranchCanker, inactiveBranchCanker, 
                    activeBoleCanker, inactiveBoleCanker, DTOP, flags, percentLive)
    tree_list <- rbind(tree_list, xlsfile)
  }
}
```

## Data Wrangling
```{r}
# Data wrangling

# change data type to integer for count data
tree_list$activeBoleCanker <- as.integer(tree_list$activeBoleCanker) 
tree_list$inactiveBoleCanker <- as.integer(tree_list$inactiveBoleCanker)
tree_list$activeBranchCanker <- as.integer(tree_list$activeBranchCanker)
tree_list$inactiveBranchCanker <- as.integer(tree_list$inactiveBranchCanker)
tree_list$flags <- as.integer(tree_list$flags)

# change data type to numeric for measured variables
tree_list$DBH_cm <- as.numeric(tree_list$DBH_cm)
tree_list$height_m <- as.numeric(tree_list$height_m)
tree_list$percentLive <- as.numeric(tree_list$percentLive)

# create new columns combining active and inactive bole and branch cankers 
piladat <- tree_list %>% 
  mutate(bole_canker = activeBoleCanker + inactiveBoleCanker,
         branch_canker = activeBranchCanker + inactiveBranchCanker,
         canker_count = bole_canker + branch_canker)

# look at range of data and missing values
summary(piladat)
# look at distribution of wpbr signs
hist(piladat$canker_count)

piladat %>% filter(canker_count > 0) %>% select(plotID, plot_type, canker_count) %>% arrange(canker_count) %>% nrow()      
```

We assessed 1,774 trees, but only 56 had cankers. Is 56 sufficient for trying to model interactions of fire, density, and tree size on blister rust? Clearly, the uninfected trees also provide information, but there are a lot of zeros in the canker count column. I started with a poisson distribution since we are working with count data for the response variable. Then I tested for overdispersion, and tried a negative binomial model since the data do seem to have a larger variance relative to the mean. 

## Fit an initial GLMM model 

```{r}
# Fit the GLMM
poisson_model <- glmer(canker_count ~ plot_type + DBH_cm + (1 | plotID), 
               data = piladat, family = poisson)

# Check model summary
summary(poisson_model)

# Assess model assumptions--looks kind of ugly
plot(poisson_model)

# try logistic regression (prescense/absence) family = binomial 

# get fire severity up and running

```
```{r}
# test for overdispersion 

# Fit negative binomial model
nb_model <- glmer.nb(canker_count ~ plot_type + DBH_cm + (1 | plotID), 
               data = piladat)

# Likelihood Ratio Test
lr_test <- anova(poisson_model, nb_model, test = "Chisq")
lr_test # data appears to be overdispersed as expected

# look for theta parameter in nb model summary
summary(nb_model)
```
## Model Comparison with Different Predictors

The negative binomial family seems to be the best choice given the overdispersion. 
```{r}
model1 <- glmer.nb(canker_count ~ plot_type + (1 | plotID), 
               data = piladat)
summary(model1)
plot(model1)
```
```{r}
model2 <- glmer.nb(canker_count ~ DBH_cm + (1 | plotID), 
               data = piladat)
summary(model2)
plot(model2) # DBH does not seem to be a significant predictor of canker count
```
```{r}
model3 <- glmer.nb(canker_count ~ height_m + (1 | plotID), 
               data = piladat)
summary(model3)
plot(model3) 
```

The two size variables do not seem to be significant predictors of wpbr (at least not alone). Plot type is a significant predictor by itself. There seems to be a strong trend in the residuals for all three models. 

I'm a bit concerned that we may not have enough infected trees to really address this quesiton because. Even though we sampled 1,774 trees, we only assessed 56 trees that definitely had wpbr. We may need to expand the definition by attempting to provide a high end estimate in addition to our low end estimate. Working with the beetle data may be better for modeling since the incidence was much higher. 

Fire data--> need a more descriptive variable (index )
Extract fire history by point (plot beginning)--history and severity
Time since fire

Proportion affected within a plot

Fire plots have less density in trees (probably overall)
Calculate basal area for PILA 
Calculate basal area for associated trees
Understory?

SEKI results
There was a trend for fire, but not super strong (maybe local reduction in ribes and PILA)
PILA (and white pine) density also not strongly predictive


